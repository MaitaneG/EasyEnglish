{% extends "base.html" %}
{% load static %}
{% block title %} Memory game {% endblock title %}
{% block content %}
<div class="home_page">
    <div class="grid_memory">
        <div class="cell">
            <div class="front" data-index="0" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="0" data-type="text">
                <p>Apple</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="1" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="1" data-type="text">
                <p>Banana</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="2" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="2" data-type="text">
                <p>Pencil</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="3" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="3" data-type="text">
                <p>Backpack</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="4" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="4" data-type="text">
                <p>Ladybug</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="5" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="5" data-type="text">
                <p>Jellyfish</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="6" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="6" data-type="text">
                <p>Hamburger</p>
            </div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="7" data-type="photo"><img></div>
            <div class="back"></div>
        </div>
        <div class="cell">
            <div class="front" data-index="7" data-type="text">
                <p>Desk</p>
            </div>
            <div class="back"></div>
        </div>
    </div>
</div>
<script>
    const card = document.querySelectorAll('.cell');
    const front = document.querySelectorAll('.front');
    var attempts = 0;

    var words=[];

    const initializer = () => {
        getCards();
        suffleImage();
        clicking();
    }

    const clicking = () => {
        for (let i = 0; i < card.length; i++) {
            card[i].addEventListener('click', (e) => {

                front[i].classList.add('flip');
                const flipped = document.querySelectorAll('.flip');

                if (flipped.length == 2) {
                    match(flipped[0], flipped[1]);
                }
            });
        }
    }

    const match = (flipped1, flipped2) => {
        if (flipped1.dataset['index'] == flipped2.dataset['index']) {
            cardsAreTheSame(flipped1, flipped2);
        } else {
            cardsNotTheSame(flipped1, flipped2);
        }
    }

    const cardsAreTheSame = (card1, card2) => {
        card1.classList.remove('flip');
        card2.classList.remove('flip');

        card1.classList.add('matched');
        card2.classList.add('matched');

        const matched = document.querySelectorAll('.matched');
        if (matched.length == 16) {
            plusPoints();
            addLearntWords();
            window.location="/game";
        }
    }

    const cardsNotTheSame = (card1, card2) => {
        attempts++;

        if (attempts < 15) {
            setTimeout(() => {
                card1.classList.remove('flip');
                card2.classList.remove('flip');
            }, 1000);
        } else {
            alert('Saiakera guztiak agortu dituzu');
        }
    }

    const getCards = () => {
        let csrftoken = '{{ csrf_token }}';
        let datuak = { quantity: 8 }
        $.ajax({
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            url: '{% url "getCards" %}',
            data: datuak,
            dataType: 'json',
            success: function (response) {
                var cards = document.querySelectorAll(".front");
                for (let i = 0; i < response.length; i++) {
                    words.push(response[i].word)
                    cards.forEach((card) => {
                        if (card.dataset['index'] == i) {
                            if (card.dataset['type'] == "photo") {
                                card.innerHTML = "<img src='/media/" + response[i].photo + "'>";
                            }
                            if (card.dataset['type'] == "text") {
                                card.innerHTML = "<p>" + response[i].word + "</p>";
                            }
                        }
                    });
                }
            },
        });
    };
    const suffleImage = () => {
        card.forEach(c => {
            const num = [...Array(card.length).keys()]
            const random = Math.floor(Math.random() * card.length)
            c.style.order = num[random] + "";
        })

        front.forEach(c => {
            c.classList.remove("matched")
        })
    }

    const plusPoints = () => {
        let csrftoken = '{{ csrf_token }}';
        let datuak = { points: 15 }
        $.ajax({
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            url: '{% url "plusPoints" %}',
            data: datuak,
            dataType: 'json',
            success: function (response) {
            },
        });
    };

    const addLearntWords = () => {
        let csrftoken = '{{ csrf_token }}';
        let datuak = JSON.stringify({ "words": words })
        console.log(datuak)
        $.ajax({
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            url: '{% url "addLearntWords" %}',
            data: datuak,
            dataType: 'json',
            success: function (response) {
            },
        });
    };

    window.onload = initializer;
</script>
{% endblock content %}